<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>context</title>
  </head>
  <body>
    <script>
      // source types, it creates a new execution context
      // 1. global code creates a global execution context to manage global mehtods and varibles
      // 2. function code, creates a function execution context to manage function methods, arguments and variables
      // 3. eval code, creates a eval execution context exclusively for eval code
      // 4. module code, creates a module execution context

      // execution context manage the variable environment and lexical environment
      // lexical environment is a data structure that holds identifier-variable mapping
      // lexical environment is created at the time of function creation

      {
        // 1. create `global execution context`
        // 2. create `lexical environment`
        // 2.1 ceate `global environment record`
        // 2.1.1 create `object environment record`: holding var global methods and variables, var x, outer(), ...
        var x = 1;
        // 2.1.2 create `declarative environment record`: holding let global variables, let y
        const y = 2; // <uninitialized>
        // 2.2 this binding: this === globalThis
        // 2.3 outer lexical environment reference: null

        function outer(a) {
          var x = 3;
          const y = 4;

          function inner(b) {
            const z = 5;
            console.log(a + b + x + y + z);
            console.log(this === globalThis);
          }

          // 7. create `function excution context for inner`
          // 8. create `function lexical evnironment forf inner`: b, arguments, z
          // 8.1 create `function environment record for inner`
          // 9. this binding(in `inner` lexical environment): this === globalThis: x, outer
          // 10. `inner` lexical environment reference: `outer` lexical environment
          inner(10);
        }

        // 3. create `function excution context for outer`
        // 4. create `function lexical evnironment forf outer`: a, arguments, x, y, outer
        // 4.1 create `function environment record for outer`
        // 5. this binding(in outer lexical environment): this === globalThis: x, outer
        // 6. `outer` lexical environment reference: `global` lexical environment
        outer(20); // 42
      }

      // temporal dead zone
      try {
        let x = 1;
        {
          // try to refer to global x but global x is hoisted, so it is in TDZ
          console.log(x); // ReferenceError: x Cannot access 'x' before initialization
          let x = 2;
        }
      } catch (e) {
        console.log(e);
      }

      // execution and block level scope
      {
        // 1. create`global execution context`
        // 2. create `global lexcial environment`
        // 2.1 create `declaretive environment record`: let x = 1
        let x = 1;

        // 3. create `block execution context`
        // 4. create `block lexical environment`
        // 4.1 create `declaretive environment record`: let x = 2
        // 5. glrobal execution context refer to `block` lexcical environment
        if (true) {
          let x = 2;
          console.log('if scope', x);
        }

        console.log('global scope', x);
      }
    </script>
  </body>
</html>
